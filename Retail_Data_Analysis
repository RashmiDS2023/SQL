select * from Customer;
select * from prod_cat_info;
select * from Transactions;

--DATA PREPARATION AND UNDERSTANDING
--. What is the total number of rows in each of the 3 tables in the database?
select (select count(*)  from Customer)as Count_Customer,(select count(*) from prod_cat_info) as Count_Prod,( select count(Transaction_id) from Transactions)as Count_Transactions;

--What is the total number of transactions that have a return?
alter  table transactions alter column total_amt float;
select count(*) as Cnt_ReturnTransactions 
from Transactions where qty<0 ;

--As you would have noticed, the dates provided across the datasets are not in a correct format. As first steps, pls convert the date variables into valid date formats before proceeding ahead. 

update Transactions set tran_date= parse(tran_date as date using 'AR-LB')

--4. What is the time range of the transaction data available for analysis? Show the output in number of days, months and years simultaneously in different columns

select (select DATEDIFF(day, min(tran_date), max(tran_date)) from Transactions) as TR_in_Days ,(select DATEDIFF(month, min(tran_date), max(tran_date)) from Transactions)as TR_in_Months,
(select DATEDIFF(year, min(tran_date), max(tran_date))
from Transactions) as TR_in_Years

--5. Which product category does the sub-category “DIY” belong to? 
select prod_cat as Prod_Cat 
from prod_cat_info 
where prod_subcat='DIY'

--DATA ANALYSIS 
--1. Which channel is most frequently used for transactions? 

select top 1 a.Channel 
from (select store_type as Channel, count(store_type) as Cnt_channel from transactions group by Store_type) as a 
order by a.Cnt_channel desc

--2. What is the count of Male and Female customers in the database? 
select (select count(*) from Customer where gender='M') as Male_Cnt,(select count(*) from Customer where gender='F') as Female_Cnt

--3. From which city do we have the maximum number of customers and how many? 
select top 1 city_code as City ,count(*) as Cnt_Cust 
from customer 
group by city_code 
order by count(*) desc 

--4. How many sub-categories are there under the Books category?
select count(prod_subcat) as Cnt_Sub_cat_books 
from prod_cat_info 
where prod_cat='Books'

--5. What is the maximum quantity of products ever ordered? 
select max(qty) as Max_Qty 
from Transactions

--6. What is the net total revenue generated in categories Electronics and Books?

select prod_cat_info.Prod_cat,round(sum(transactions.total_amt),0) as Total_Rev
from prod_cat_info,transactions 
where prod_cat_info.prod_cat_code=Transactions.prod_cat_code 
group by prod_cat_info.prod_cat
having prod_cat_info.prod_cat in ('Electronics','Books')


select P.Prod_cat,round(sum(T.total_amt),0) as Total_Rev
from prod_cat_info as P inner join transactions as T on P.prod_cat_code=T.prod_cat_code
where P.prod_cat in ('Electronics','Books')
group by P.prod_cat


--7. How many customers have >10 transactions with us, excluding returns?

select count(*) as Cnt_cust_greater_10_tran from (select cust_id, count(cust_id)as Cnt_cust
from transactions 
where qty>0 
group by cust_id
having count(cust_id)>10) as a 


--8. What is the combined revenue earned from the “Electronics” & “Clothing” categories, from “Flagship stores”? 
select round(sum(T.total_amt),0) as Combined_Total_Rev
from prod_cat_info as P inner join transactions as T on P.prod_cat_code=T.prod_cat_code
where P.prod_cat in ('Electronics','Clothing') and t.Store_type='Flagship store'

--9. What is the total revenue generated from “Male” customers in “Electronics” select * from category? Output should display total revenue by prod sub-cat

select * from transactions
select * from customer

select sum(t.total_amt) as Total_Revenue, p.prod_subcat  
from transactions as t left join customer as C on t.cust_id=c.customer_Id  left join prod_cat_info as P on  t.prod_subcat_code=p.prod_sub_cat_code
where c.Gender='M' and p.prod_cat='Electronics' 
group by p.prod_subcat

--10.What is percentage of sales and returns by product sub category; display only top 5 sub categories in terms of sales?
select top 5 p.Prod_Subcat, round(sum(case when t.qty>0 then t.qty else 0 end)*100/(select sum(qty) from transactions),2) as Per_Sales, round(sum(case when t.qty <0 then t.qty  else 0 end)*100/(select sum(qty) from transactions),2)as Per_Returns 
from Transactions t, prod_cat_info p
where t.prod_subcat_code=p.prod_sub_cat_code
group by p.prod_subcat
order by Per_Sales desc

--11. For all customers aged between 25 to 35 years find what is the net total revenue generated by these consumers in last 30 days of transactions from max transaction date available in the data? 

update Customer set DOB= parse(DOB as date using 'AR-LB')

select * from (select c.Customer_id,t.tran_date, sum(t.total_amt) as Total_Revenue,DATEDIFF(Year,DOB,cast(getdate() as date )) as Age 
from Customer c, transactions t 
where c.customer_Id=t.cust_id  
group by c.customer_Id,dob,t.tran_date
having datediff(DAY, t.tran_date, (select max(tran_date) from Transactions)) <=30) as A
where a.Age between 25 and 35 
order by a.age

--12.Which product category has seen the max value of returns in the last 3 months of transactions?


select top 1  prod_cat_info.prod_cat, sum(case when total_amt<0 then total_amt else 0 end) as Max_Value_Returns from prod_cat_info, Transactions t 
where prod_cat_info.prod_cat_code=t.prod_cat_code
group by prod_cat_info.prod_cat,t.tran_Date
having datediff(month,tran_date,(select max(tran_date) from Transactions)) <=3
order by Max_Value_Returns 

--13.Which store-type sells the maximum products; by value of sales amount and by quantity sold? 
alter table transactions alter column qty float
select top 1 t.Store_Type, sum(t.qty) as Qty_Sold,sum(t.total_amt) as Sales_Amount 
from Transactions t 
group by t.Store_type
order by Sales_Amount,Qty_Sold

--14.What are the categories for which average revenue is above the overall average.

select  a.Prod_Cat, A.Avg_Rev_Cat from (select p.Prod_cat, avg(t.total_amt) as Avg_Rev_Cat
from prod_cat_info p, Transactions t
where t.prod_cat_code=p.prod_cat_code
group by p.prod_cat)as A, transactions
group by a.prod_cat, A.Avg_Rev_Cat
having A.avg_rev_cat > avg(Transactions.total_amt)

--15. Find the average and total revenue by each subcategory for the categories which are among top 5 categories in terms of quantity sold.

select  a.Prod_cat,p.Prod_subcat,round(avg(t.total_amt),2) as Avg_Rev, round(sum(t.total_amt),2)as Tatol_Rev from Transactions t , prod_cat_info p,(select top 5 p.prod_cat,sum(t.qty) As Qty_sold from transactions t, prod_cat_info p 
where p.prod_cat_code=t.prod_cat_code and p.prod_sub_cat_code=t.prod_subcat_code
group by p.prod_cat
order by Qty_sold desc)as a
where t.prod_cat_code=p.prod_cat_code and t.prod_subcat_code=p.prod_sub_cat_code and a.prod_cat=p.prod_cat
group by p.prod_subcat, a.prod_cat
order by a.prod_cat



